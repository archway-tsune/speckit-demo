# Feature Specification: カート管理機能

**Feature Branch**: `002-cart-manage`
**Created**: 2026-02-27
**Status**: Draft

## ユーザーシナリオとテスト

### ユーザーストーリー 1 - 商品をカートに追加する（優先度: P1）

ログイン済みの購入者が商品詳細ページの「カートに追加」ボタンを押すと、カートに商品が追加される。同一商品を再度追加した場合は数量が自動的に増加する。在庫不足・在庫切れ時は追加を拒否してエラーを通知する。追加成功時はフィードバックを表示し、ヘッダーのカートアイコン件数が更新される。未ログイン時はログインページにリダイレクトされる。

**この優先度の理由**: カート追加はカート管理機能の入口であり、他の全ストーリーの前提となる最重要フロー。

**独立テスト**: 商品詳細ページで「カートに追加」を押し、成功フィードバックの表示・カートアイコン件数の更新を確認することで単独で検証可能。

**受け入れシナリオ**:

1. **Given** ログイン済み購入者が在庫あり商品の詳細ページにいる、**When** 「カートに追加」ボタンを押す、**Then** 成功フィードバックが表示され、カートアイコンの件数が1増加する
2. **Given** カートに同一商品が1点ある、**When** 再度「カートに追加」を押す、**Then** カート内の数量が2になり、追加成功フィードバックが表示される
3. **Given** カート内の数量が在庫数と同じ、**When** 「カートに追加」を押す、**Then** 追加を拒否し在庫不足のエラーメッセージが表示される
4. **Given** stock=0 の商品の詳細ページにいる、**When** 詳細ページを表示する、**Then** 「カートに追加」ボタンが無効化されている
5. **Given** 未ログインのユーザーが商品詳細ページにいる、**When** 「カートに追加」ボタンを押す、**Then** ログインページにリダイレクトされ、ログイン後は元の商品詳細ページに戻る
6. **Given** 「カートに追加」の処理中、**When** ボタンが連打される、**Then** ボタンが無効化されて二重送信が防止される

---

### ユーザーストーリー 2 - カート内容を確認する（優先度: P2）

ログイン済みの購入者がカートページで、カート内の商品一覧（画像・名前・単価・数量・小計）と合計金額（商品合計・消費税・総合計）を確認できる。カートが空の場合は空状態メッセージと商品一覧への導線を表示する。

**この優先度の理由**: カートに追加した内容を確認する機能はカート管理の中核。追加機能の次に不可欠なフロー。

**独立テスト**: カートに商品を追加した後、カートページを開いて商品情報と合計金額の正確な表示を確認することで単独で検証可能。

**受け入れシナリオ**:

1. **Given** カートに複数商品が入っている、**When** カートページを開く、**Then** 各商品の画像・商品名・単価・数量・小計が一覧表示される
2. **Given** カートに商品が入っている、**When** カートページを開く、**Then** 商品合計・消費税（10%、端数切り捨て）・総合計が正しく表示される
3. **Given** カートが空の状態、**When** カートページを開く、**Then** 「カートに商品がありません」メッセージと商品一覧への導線が表示される

---

### ユーザーストーリー 3 - カート内の数量を変更する（優先度: P3）

ログイン済みの購入者がカートページで、商品ごとの数量を変更でき、変更に応じて小計・合計金額が即時更新される。在庫超過の場合は変更を拒否してエラーを通知する。

**この優先度の理由**: カートに追加・確認ができた後に必要な編集機能。P1・P2 の後に独立して実装可能。

**独立テスト**: カートに商品を追加後、カートページで数量を変更し、小計・合計の即時更新と在庫超過時のエラー表示を確認することで単独で検証可能。

**受け入れシナリオ**:

1. **Given** カートに商品がある、**When** 数量を1〜99の範囲かつ在庫数以下に変更する、**Then** 小計と合計金額が即時更新される
2. **Given** 商品の在庫数が5の商品がカートにある、**When** カート数量を6に変更しようとする、**Then** 変更を拒否し在庫不足のエラーメッセージが表示される
3. **Given** 数量セレクタがある、**When** 1未満または100以上の値を入力しようとする、**Then** 入力が制限され変更できない

---

### ユーザーストーリー 4 - カートから商品を削除する（優先度: P4）

ログイン済みの購入者がカートページで商品を削除できる。削除前に確認ダイアログが表示され、最後の商品を削除するとカートが空になる。

**この優先度の理由**: 削除機能は必要だが、追加・確認・数量変更の後でも十分に機能する。

**独立テスト**: カートに商品を追加後、削除ボタンを押して確認ダイアログを承認し、商品が削除されることを確認することで単独で検証可能。

**受け入れシナリオ**:

1. **Given** カートに商品がある、**When** 削除ボタンを押す、**Then** 確認ダイアログが表示される
2. **Given** 確認ダイアログが表示されている、**When** 削除を承認する、**Then** 商品がカートから削除される
3. **Given** カートに1点だけ商品がある、**When** 削除を承認する、**Then** カートが空になり「カートに商品がありません」メッセージが表示される
4. **Given** 確認ダイアログが表示されている、**When** キャンセルする、**Then** 削除されずカート内容が維持される

---

### ユーザーストーリー 5 - カート内容を永続化する（優先度: P5）

ログイン済みの購入者がページ遷移やブラウザリロードを行っても、カートの内容が保持される。

**この優先度の理由**: UX 上重要だが、他の機能が実装された後に追加できる横断的関心事。

**独立テスト**: カートに商品追加後、別ページに移動してカートページに戻り、または画面をリロードして、カート内容が保持されていることを確認することで単独で検証可能。

**受け入れシナリオ**:

1. **Given** カートに商品がある、**When** 他のページに遷移してカートページに戻る、**Then** カートの内容が保持されている
2. **Given** カートに商品がある、**When** ブラウザをリロードする、**Then** カートの内容が保持されている

---

### エッジケース

- カートに同一商品を追加し続け、合計数量が在庫数に達した場合は？ → 追加を拒否し在庫不足エラーを表示する
- 数量変更で合計が99を超えようとする場合は？ → 99を上限として制限し変更を拒否する
- ネットワークエラーでカート操作APIが失敗した場合は？ → エラーメッセージを表示しカートの状態は変更しない
- カート内商品が後から非公開になった場合は？ → カート表示時は再確認せず、購入フロー時に検証する（本フィーチャーのスコープ外）

## 要件

### 機能要件

- **FR-001**: 購入者はログイン済みの場合に限り、商品詳細ページから商品をカートに追加できる
- **FR-002**: カートに追加時、同一商品が既に存在する場合は数量を1加算する（新規追加ではなくマージ）
- **FR-003**: カート追加時に「カート内数量 + 1 > 在庫数」の場合は追加を拒否し、在庫不足エラーメッセージを表示する
- **FR-004**: stock=0 の商品は「カートに追加」ボタンを無効化して表示する
- **FR-005**: カート追加処理中はボタンを無効化して二重送信を防止する
- **FR-006**: カート追加成功時にフィードバックメッセージを表示し、ヘッダーのカートアイコン件数をカート合計数量に更新する
- **FR-007**: 未ログイン購入者が商品詳細ページでカート追加を試みた場合、ログインページにリダイレクトし、ログイン後に元の商品詳細 URL に戻す
- **FR-008**: カートページは商品ごとに画像・商品名・単価・数量・小計を表示する
- **FR-009**: カートページは商品合計・消費税（商品合計 × 10%、端数切り捨て）・総合計（商品合計＋消費税）を表示する
- **FR-010**: カートが空の場合は「カートに商品がありません」メッセージと商品一覧ページへのリンクを表示する
- **FR-011**: カート内商品の数量は1〜99の範囲かつ在庫数以下でのみ変更可能とし、変更時に小計・合計を即時更新する
- **FR-012**: 在庫数を超える数量への変更は拒否し、在庫不足エラーメッセージを表示する
- **FR-013**: カートから商品削除前に確認ダイアログを表示する
- **FR-014**: 削除確認後に商品をカートから取り除き、カートが空になった場合は空状態表示に切り替える
- **FR-015**: カートの内容はページ遷移・ブラウザリロード後も保持される（セッション内永続化）

### 主要エンティティ

- **カート（Cart）**: 購入者1人につき1つのカート。ユーザーIDで紐づく。カートアイテムのコレクションを持つ。
- **カートアイテム（CartItem）**: カート内の1商品エントリ。商品ID・数量（1〜99）を保持する。カートに属し、商品（Product）を参照する。
- **商品（Product）**: カタログ機能で管理済み。CartItem が参照する。在庫数（stock）を持つ。

## 成功基準

### 測定可能な成果

- **SC-001**: 購入者が商品詳細ページからカートへの追加操作を3秒以内に完了できる
- **SC-002**: カートページで商品合計・消費税・総合計がすべて正確に表示される（計算誤差ゼロ）
- **SC-003**: 在庫不足・在庫切れ状態での誤ったカート追加操作が100%防止される
- **SC-004**: ページ遷移・リロード後のカート内容の保持が100%達成される（セッション内）
- **SC-005**: 未ログイン状態でのカート操作が100%ログインページにリダイレクトされる

## 前提と依存

### 前提条件

- カタログ機能（001-catalog-browse）が実装済みで、商品詳細ページが利用可能
- 購入者（buyer）ロールのログイン機能が利用可能
- 消費税は一律10%（軽減税率対象外）
- カートの永続化はインメモリ実装とし、DB 永続化は将来フェーズとする

### スコープ外

- 購入・決済フロー（チェックアウト）
- カートの有効期限管理
- 複数デバイス間のカート同期
- ゲストカート（未ログインでのカート保持）
- クーポン・割引適用
