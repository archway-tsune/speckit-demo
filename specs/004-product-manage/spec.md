# 機能仕様書: 商品管理機能

**フィーチャーブランチ**: `004-product-manage`
**作成日**: 2026-02-27
**ステータス**: ドラフト

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 商品一覧表示（管理者） (優先度: P1)

管理者が全商品をテーブル形式で確認できる。各行に商品名・価格・在庫数・ステータスが表示され、編集・削除の操作ができる。商品数が多い場合はページネーションで閲覧できる。一覧ページには「新規登録」ボタンを配置する。

**優先理由**: 他のすべての管理操作の起点となる画面。一覧が表示できなければ、編集・削除・ステータス変更も利用できない。

**独立テスト**: 管理者としてログインし `/admin/products` にアクセスすると商品テーブルが表示され、各行に商品名・価格・在庫数・ステータスが確認できることを検証できる。

**受け入れシナリオ**:

1. **Given** 管理者としてログイン済み、**When** `/admin/products` にアクセスする、**Then** 全商品のテーブルが表示される
2. **Given** 商品一覧ページを表示中、**When** ページを確認する、**Then** 各行に商品名・価格・在庫数・ステータス・編集リンク・削除ボタンが表示される
3. **Given** 商品が20件を超える、**When** 一覧を表示する、**Then** ページネーションが表示され次のページに遷移できる
4. **Given** 商品一覧ページを表示中、**When** ページを確認する、**Then** 「新規登録」ボタンが表示される
5. **Given** 購入者（buyer）としてログイン済み、**When** `/admin/products` にアクセスする、**Then** アクセスが拒否される
6. **Given** 未ログイン状態、**When** `/admin/products` にアクセスする、**Then** 管理者ログインページにリダイレクトされる

---

### ユーザーストーリー 2 - 商品新規登録 (優先度: P2)

管理者が新しい商品を登録できる。商品名・価格を必須入力し、説明・画像URL・在庫数を任意入力する。登録後は「下書き」ステータスで作成され、商品一覧に遷移する。

**優先理由**: カタログに商品が存在しなければ購入者向け機能が成立しない。商品の新規追加は管理業務の核となる操作。

**独立テスト**: 管理者として商品登録フォームに名前と価格を入力して送信すると、下書き状態で商品が作成され一覧に表示されることを検証できる。

**受け入れシナリオ**:

1. **Given** 管理者が新規登録フォームを表示している、**When** 商品名と価格を入力して送信する、**Then** 下書きステータスで商品が作成され商品一覧に遷移する
2. **Given** 商品名が空欄、**When** フォームを送信する、**Then** バリデーションエラーが表示され送信されない
3. **Given** 商品名が201文字以上、**When** フォームを送信する、**Then** バリデーションエラーが表示される
4. **Given** 価格が空欄、**When** フォームを送信する、**Then** バリデーションエラーが表示される
5. **Given** 価格が負の値、**When** フォームを送信する、**Then** バリデーションエラーが表示される
6. **Given** 画像URLに無効な形式の文字列を入力、**When** フォームを送信する、**Then** バリデーションエラーが表示される
7. **Given** フォームを表示中、**When** 「キャンセル」をクリックする、**Then** 商品一覧ページに遷移する

---

### ユーザーストーリー 3 - 商品編集 (優先度: P3)

管理者が既存商品の情報を編集できる。編集ページを開くと既存データがフォームにプリロードされ、変更したフィールドのみ更新される部分更新をサポートする。

**優先理由**: 登録した商品の情報修正や在庫数更新は日常的な管理業務。価格・在庫数など動的な情報の更新に必要。

**独立テスト**: 管理者として既存商品の編集ページを開き、名前を変更して保存すると変更が反映されることを検証できる。

**受け入れシナリオ**:

1. **Given** 管理者が商品一覧で「編集」リンクをクリック、**When** 編集ページが表示される、**Then** 既存のすべてのフィールド値がフォームにプリロードされている
2. **Given** 商品名を変更して保存、**When** 一覧に戻る、**Then** 更新された商品名が反映されている
3. **Given** 説明フィールドのみ変更、**When** 保存する、**Then** 説明のみ更新され他フィールドは変更されない（部分更新）
4. **Given** 存在しない商品IDにアクセス、**When** 編集ページを開こうとする、**Then** 404エラーが表示される
5. **Given** フォームを表示中、**When** 「キャンセル」をクリックする、**Then** 商品一覧ページに遷移する

---

### ユーザーストーリー 4 - ステータス変更 (優先度: P4)

管理者が商品一覧画面のドロップダウンから商品ステータスを即時変更できる。ステータスは「下書き」・「公開中」・「アーカイブ」の3種類で、全ステータス間の遷移が可能。

**優先理由**: 商品の公開・非公開の切り替えは運用の核。別画面に遷移せず一覧から直接変更できることで操作効率を向上させる。

**独立テスト**: 管理者として商品一覧でドロップダウンから「公開中」を選択すると、即座にステータスが更新されることを検証できる。

**受け入れシナリオ**:

1. **Given** 商品一覧を表示中、**When** ドロップダウンで「公開中」を選択する、**Then** 即座にステータスが「公開中」に変更される
2. **Given** 公開中の商品、**When** ドロップダウンで「アーカイブ」を選択する、**Then** ステータスが「アーカイブ」に変更される
3. **Given** アーカイブの商品、**When** ドロップダウンで「下書き」を選択する、**Then** ステータスが「下書き」に変更される（すべての遷移が可能）

---

### ユーザーストーリー 5 - 商品削除 (優先度: P5)

管理者が不要な商品を削除できる。削除前に確認ダイアログを表示し、誤削除を防止する。

**優先理由**: 商品削除は不可逆操作のため、確認ステップを含む安全な削除フローの提供が必要。他のストーリーが揃った後に追加する機能。

**独立テスト**: 管理者として商品一覧で削除ボタンをクリックし確認ダイアログで承認すると、商品が削除されて一覧から消えることを検証できる。

**受け入れシナリオ**:

1. **Given** 商品一覧を表示中、**When** 削除ボタンをクリックする、**Then** 確認ダイアログが表示される
2. **Given** 確認ダイアログが表示中、**When** 確認する、**Then** 商品が削除され一覧から消える
3. **Given** 確認ダイアログが表示中、**When** キャンセルする、**Then** 商品は削除されず一覧に残る

---

### エッジケース

- 商品名が1文字または200文字のとき（境界値）は正常に登録できるか？
- 在庫数が0のとき（最小値）は正常に登録できるか？
- 価格が0のとき（無料商品）は正常に登録できるか？
- 説明が2000文字のとき（最大値）は正常に登録できるか？
- 商品が0件のとき一覧ページに空メッセージが表示されるか？
- 画像URLが空欄のとき（任意項目のため）正常に登録できるか？

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは管理者（admin）ロールのユーザーのみが商品管理機能にアクセスできるようにしなければならない
- **FR-002**: システムは未認証ユーザーを管理者ログインページにリダイレクトしなければならない
- **FR-003**: システムは購入者（buyer）ロールのユーザーが商品管理ページにアクセスした場合、アクセス拒否を返さなければならない
- **FR-004**: システムは全商品をテーブル形式（商品名・価格・在庫数・ステータス）で一覧表示できなければならない
- **FR-005**: システムは商品一覧をページ単位で表示し、ページ送りをサポートしなければならない
- **FR-006**: システムは商品名（必須・1〜200文字）と価格（必須・0以上の整数）のバリデーションを行わなければならない
- **FR-007**: システムは説明（任意・最大2000文字）・画像URL（任意・有効なURL形式）・在庫数（任意・0以上の整数）のバリデーションを行わなければならない
- **FR-008**: システムは商品を新規登録する際、初期ステータスを「下書き」（draft）に設定しなければならない
- **FR-009**: システムは商品登録・編集完了後、商品一覧ページに自動遷移しなければならない
- **FR-010**: システムは編集フォームを開いた際、既存の商品データをすべてのフィールドにプリロードしなければならない
- **FR-011**: システムは変更されたフィールドのみを更新する部分更新をサポートしなければならない
- **FR-012**: システムは存在しない商品IDへの編集アクセスに対して404エラーを表示しなければならない
- **FR-013**: システムは削除操作の前に確認ダイアログを表示しなければならない
- **FR-014**: システムは商品一覧のドロップダウンからステータスを即時変更できなければならない
- **FR-015**: ステータスは「下書き」（draft）・「公開中」（published）・「アーカイブ」（archived）の3種類で、すべての遷移が許可される
- **FR-016**: システムは登録・編集フォームに「キャンセル」ボタンを提供し、商品一覧に戻れるようにしなければならない

### 主要エンティティ

- **Product（商品）**: 商品情報を表すエンティティ。属性: 一意のID・商品名（1〜200文字）・説明（最大2000文字・任意）・価格（0以上の整数）・画像URL（有効なURL・任意）・在庫数（0以上の整数・デフォルト0）・ステータス（draft/published/archived）・作成日時・更新日時

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 管理者は商品の新規登録を3ステップ以内（一覧→登録フォーム→送信）で完了できる
- **SC-002**: 商品一覧のステータス変更は画面遷移なしで即座に反映される
- **SC-003**: 削除操作は確認ステップを経ることで誤削除を防止できる
- **SC-004**: 編集フォームへのアクセス時に既存データが自動的にプリロードされ、管理者は変更が必要なフィールドのみを入力すればよい
- **SC-005**: buyer権限のユーザーが管理画面にアクセスしようとした場合、100%アクセス拒否される
- **SC-006**: 商品一覧ページは1秒以内に表示される（通常の商品数範囲内）

## 前提条件と依存関係

### 前提条件

- セッション認証（Cookie-based）とロール判定（admin/buyer）が実装済み
- 購入者向けカタログ閲覧機能（catalog ドメイン）が実装済み
- 商品管理（product ドメイン）はカタログ（catalog ドメイン）とは独立した境界づけられたコンテキストとして実装する

### スコープ外

- 在庫引き当て（注文時の在庫減算）
- 画像ファイルのアップロード機能（URL直接入力方式を採用）
- 商品カテゴリ管理
- 商品の一括操作（一括削除・一括ステータス変更）

### 仮定

- 管理者向けページのルートは `/admin/products` を使用する
- ページネーションの1ページあたりの表示件数は20件とする
- 在庫数フィールドの入力がない場合、デフォルト値は0とする
- ステータス変更はリアルタイム（ページリロード不要）で反映される
