# Feature Specification: 注文機能

**Feature Branch**: `003-order-manage`
**Created**: 2026-02-27
**Status**: Draft
**Input**: 購入者がカート内の商品を確認して注文を確定し、注文履歴・注文詳細を閲覧できる機能。管理者は全注文の一覧閲覧とステータス更新ができる。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - チェックアウトと注文確定 (優先度: P1)

購入者はカート画面から「注文手続きへ」ボタンをクリックしてチェックアウト画面に進み、注文内容を確認した上で「注文を確定」ボタンで注文を作成する。注文完了後、カートは自動的にクリアされ、注文完了画面に注文IDとお礼メッセージが表示される。

**この優先度の理由**: 注文確定はECサイトの中核機能であり、売上に直結する最重要ユーザーアクション。

**独立テスト**: カートに商品を追加した状態でチェックアウトフローを実行し、注文が作成・保存されることを確認。注文完了画面の表示と、カートがクリアされることを検証することで独立して価値を提供する。

**受け入れシナリオ**:

1. **Given** カートに1件以上の商品がある購入者が、**When** カート画面を表示する、**Then** 「注文手続きへ」ボタンが表示される
2. **Given** カートが空の購入者が、**When** カート画面を表示する、**Then** 「注文手続きへ」ボタンは表示されない
3. **Given** カートに商品がある購入者が、**When** 「注文手続きへ」ボタンをクリックする、**Then** チェックアウト画面に遷移し、商品名・単価・数量・小計・消費税（10%）・合計金額が表示される
4. **Given** チェックアウト画面にいる購入者が、**When** 「注文を確定」ボタンをクリックする、**Then** 注文が作成され、小計・消費税（10%端数切り捨て）・合計金額（税込）が記録され、注文完了画面に注文IDとお礼メッセージが表示される
5. **Given** 注文が確定した後、**When** カート画面に遷移する、**Then** カートが空になっている

---

### ユーザーストーリー 2 - 注文履歴閲覧 (優先度: P2)

購入者はナビゲーションから自分の注文履歴を一覧で確認できる。各注文の注文ID先頭8桁・注文日・商品数・合計金額・ステータスが表示され、20件単位のページネーションで過去の注文を遡れる。

**この優先度の理由**: 購入者が自分の注文状況を把握できることは購入後のサポートに不可欠。チェックアウト完了後に次に必要な機能。

**独立テスト**: 複数注文が存在する状態で注文履歴ページにアクセスし、一覧表示・ページネーション・自分の注文のみ表示されることを検証することで独立して価値を提供する。

**受け入れシナリオ**:

1. **Given** 注文が存在する購入者が、**When** 注文履歴ページにアクセスする、**Then** 自分の注文一覧が表示される（注文ID先頭8桁・注文日・商品数・合計金額・ステータス）
2. **Given** 21件以上の注文がある購入者が、**When** 注文履歴ページを表示する、**Then** 20件が表示されページネーションコントロールが表示される
3. **Given** 注文履歴一覧にいる購入者が、**When** 特定の注文をクリックする、**Then** 注文詳細画面に遷移する

---

### ユーザーストーリー 3 - 注文詳細閲覧 (優先度: P3)

購入者は特定の注文の詳細情報（注文ID・注文日時・ステータス・商品一覧・合計金額）を確認できる。他人の注文には一切アクセスできない。

**この優先度の理由**: 注文履歴一覧の次に必要なドリルダウン機能。US2の後に提供することで完全な注文追跡体験を実現する。

**独立テスト**: 特定の注文IDの詳細ページにアクセスし、注文情報が正しく表示されること、他人の注文IDでアクセスするとアクセス拒否されることを検証することで独立して価値を提供する。

**受け入れシナリオ**:

1. **Given** 注文を持つ購入者が、**When** 自分の注文詳細ページにアクセスする、**Then** 注文ID・注文日時・ステータス・商品一覧（商品名・単価・数量・小計）・消費税・合計金額が表示される
2. **Given** ある購入者が、**When** 他の購入者の注文詳細URLに直接アクセスする、**Then** アクセスが拒否される（404またはアクセス拒否画面）

---

### ユーザーストーリー 4 - 管理者注文管理 (優先度: P4)

管理者は全ユーザーの注文を一覧で確認し、ステータスで絞り込みができる。ステータス遷移ルールに従って注文ステータスを更新できる。購入者は管理者ページにアクセスできない。

**この優先度の理由**: バックオフィス運用に必須の機能。購入者向け機能が完成した後に実装する。

**独立テスト**: 管理者アカウントでログインし、全注文一覧の閲覧・ステータス絞り込み・ステータス更新（有効遷移・無効遷移）を検証することで独立して価値を提供する。

**受け入れシナリオ**:

1. **Given** 管理者が注文管理ページにアクセスする、**When** ページを表示する、**Then** 全ユーザーの注文一覧が20件単位で表示される
2. **Given** 管理者が注文一覧を表示している、**When** ステータスフィルターを選択する、**Then** 選択したステータスの注文のみ表示される
3. **Given** 管理者が「保留中」の注文を見ている、**When** ステータスを「確認済み」に更新する、**Then** ステータスが「確認済み」に変更される
4. **Given** 管理者が「保留中」または「確認済み」の注文を見ている、**When** キャンセル操作を行う、**Then** 注文ステータスが「キャンセル」に変更される
5. **Given** 管理者が「配送完了」または「キャンセル」の注文を見ている、**When** ステータス変更を試みる、**Then** 変更が拒否される
6. **Given** 購入者ロールのユーザーが、**When** 管理者注文管理ページのURLに直接アクセスする、**Then** アクセスが拒否される

---

### ユーザーストーリー 5 - アクセス制御とリダイレクト (優先度: P5)

未ログインユーザーが保護ページ（チェックアウト・注文履歴・注文詳細）にアクセスした場合、ログインページにリダイレクトされ、ログイン後に元のページに復帰する。

**この優先度の理由**: セキュリティの基本要件。認証済みユーザー向け機能全体に適用されるが、既存の認証基盤で部分的にカバーされている。

**独立テスト**: 未ログイン状態で保護URLにアクセスし、ログインページへのリダイレクトとログイン後の元ページ復帰を検証することで独立して価値を提供する。

**受け入れシナリオ**:

1. **Given** 未ログインユーザーが、**When** チェックアウト・注文履歴・注文詳細ページにアクセスする、**Then** ログインページにリダイレクトされる
2. **Given** 未ログインユーザーがリダイレクトされたログインページで、**When** ログインする、**Then** 元々アクセスしようとしたページに復帰する

---

### エッジケース

- カートが空の状態でチェックアウトURLに直接アクセスした場合はカートページにリダイレクトする
- 注文確定時に税の計算で端数（小数点以下）が生じた場合は切り捨てる
- 存在しない注文IDへのアクセスは404を返す
- 管理者が許可されていないステータス遷移（例: 配送完了→確認済み）を試みた場合はエラーを返す
- 未ログインでアクセスした場合のリダイレクト先URLにクエリパラメーターが含まれていてもログイン後に正しく復帰する

## 要件 *(必須)*

### 機能要件

- **FR-001**: カート画面にカートが空でない場合、「注文手続きへ」ボタンを表示する
- **FR-002**: カート画面にカートが空の場合、「注文手続きへ」ボタンを非表示にする
- **FR-003**: チェックアウト画面で注文内容（商品名・単価・数量・小計・消費税・合計金額）を表示する
- **FR-004**: 「注文を確定」ボタン押下で注文を作成し、小計・消費税（10%、端数切り捨て）・合計金額（税込）を記録する
- **FR-005**: 注文作成後、カートを自動的にクリアする
- **FR-006**: 注文完了画面に注文IDとお礼メッセージを表示する
- **FR-007**: 購入者は自分の注文一覧を閲覧できる（注文ID先頭8桁・注文日・商品数・合計金額・ステータス）
- **FR-008**: 注文一覧は1ページあたり20件のページネーションを提供する
- **FR-009**: 注文詳細画面で注文ID・注文日時・ステータス・商品一覧（商品名・単価・数量・小計）・消費税・合計金額を表示する
- **FR-010**: 購入者は他人の注文詳細にアクセスできない（404またはアクセス拒否）
- **FR-011**: 管理者は全ユーザーの注文を一覧閲覧できる（ステータス絞り込み付き、20件/ページ）
- **FR-012**: 管理者はステータス遷移ルールに従って注文ステータスを更新できる（保留中→確認済み→発送済み→配送完了、保留中・確認済みからキャンセル可）
- **FR-013**: 配送完了・キャンセル済みの注文はステータス変更不可
- **FR-014**: 未ログインユーザーがチェックアウト・注文履歴・注文詳細にアクセスした場合、ログインページにリダイレクトし、ログイン後に元のページへ復帰する
- **FR-015**: 購入者は管理者の注文管理ページにアクセスできない（アクセス拒否）

### 主要エンティティ

- **注文 (Order)**: 注文ID・購入者ID・注文日時・ステータス・小計（税抜）・消費税・合計金額（税込）。カート内容から生成され、作成後は購入者が変更できない
- **注文明細 (OrderItem)**: 注文ID・商品ID・商品名・単価・数量・小計。注文作成時点の商品情報スナップショット
- **注文ステータス (OrderStatus)**: 保留中(pending)・確認済み(confirmed)・発送済み(shipped)・配送完了(delivered)・キャンセル(cancelled)。遷移ルールあり

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 購入者はカートに商品がある状態からチェックアウト完了まで3分以内に注文を確定できる
- **SC-002**: 注文確定後、カートが即座にクリアされ注文完了画面に注文IDが表示される（遷移2秒以内）
- **SC-003**: 注文一覧・注文詳細ページが2秒以内に表示される
- **SC-004**: 管理者は1画面内でステータスを更新でき、無効な遷移は明確なエラーメッセージで拒否される
- **SC-005**: 未認可アクセス（未ログイン・権限不足）は100%ブロックされ、適切にリダイレクト/拒否される
- **SC-006**: 消費税計算（10%・端数切り捨て）が全注文で正確に適用される

## 前提条件

- カート機能（カートの取得・操作API）が実装済みであること
- セッション認証（buyer/adminロール）が実装済みであること
- 決済処理および配送先住所の入力は本スコープ外とする
- 注文のキャンセルは管理者のみが実行可能（購入者からのキャンセルは本スコープ外）
